<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{productname}} Admin Dashboard</title>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            /* align with homepage/register design tokens */
            --bg-color: #0a0f1c;
            --panel-bg: rgba(18,26,44,0.88);
            --card-bg-color: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            --surface: rgba(255,255,255,0.03);
            --border-color: rgba(255,255,255,0.06);
            --text-color-primary: #e6edf3;
            --text-color-secondary: rgba(230,237,243,0.65);
            --link-color: #9ecbff;
            --accent-1: #2f7bff;
            --accent-2: #57c2ff;
            --btn-gradient: linear-gradient(140deg, var(--accent-1), var(--accent-2));
            --shadow-color: rgba(2,6,16,0.6);
            --danger-color: #f28b82;
            --hover-bg-color: rgba(255,255,255,0.05);
        }

        body.light-mode {
            --bg-color: #ffffff;
            --panel-bg: #ffffff;
            --card-bg-color: rgba(255,255,255,0.98);
            --border-color: rgba(18,38,63,0.08);
            --text-color-primary: #0b1220;
            --text-color-secondary: rgba(11,18,32,0.65);
            --link-color: #1a4aa3;
            --accent-1: #2f7bff;
            --accent-2: #57c2ff;
            --btn-gradient: linear-gradient(140deg, var(--accent-1), var(--accent-2));
            --shadow-color: rgba(16,24,40,0.06);
            --danger-color: #d93025;
            --hover-bg-color: rgba(0,0,0,0.04);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html, body { height: 100%; font-family: 'Manrope', sans-serif; }

        body {
            background: var(--bg-color);
            color: var(--text-color-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 14px;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        a { color: var(--link-color); text-decoration: none; font-weight: 600; }

        /* Subtle page background accents */
        body::before { content: ""; position: fixed; inset: -20%; background: linear-gradient(160deg,#070b16,#0a1226,#0c1733); z-index: -2; filter: blur(12px); }
        body::after { content: ""; position: fixed; inset: -10%; background: radial-gradient(700px 600px at 75% 70%, rgba(255,255,255,0.04), transparent 55%); z-index: -1; opacity: 0.6; pointer-events: none; }
        body.light-mode::before { background: linear-gradient(180deg,#ffffff,#f7fbff); filter:none; }

        /* Card wrapper to match site UI */
        .card-wrap { width: 100%; display:flex; justify-content:center; padding: 2rem 1rem; }
        .card { width: 100%; max-width: 1200px; border-radius: 18px; overflow: hidden; border: 1px solid var(--border-color); background: var(--card-bg-color); box-shadow: 0 30px 80px var(--shadow-color); }

        /* preserve and style the original dashboard container inside the card */
        .dashboard-container { padding: 24px; }

        .headings { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1.5rem; margin-bottom:1.5rem; }
        .logo-title { display:flex; align-items:center; gap:1rem; }
        .logo { width:40px; height:40px; display:block; }
        .title-group h1 { font-family: 'Space Grotesk', sans-serif; font-size:22px; font-weight:700; margin:0; color:var(--text-color-primary); }
        .title-group h2 { font-family: 'Manrope', sans-serif; font-size:13px; color:var(--text-color-secondary); margin:0; }

        .header-actions { display:flex; align-items:center; gap:0.75rem; }
        .counts { display:flex; gap:0.75rem; }
        .counts h3 { background:var(--panel-bg); padding:0.5rem 0.9rem; border-radius:10px; margin:0; font-size:0.95rem; font-weight:600; border:1px solid var(--border-color); color:var(--text-color-primary); }

        .tab { border-bottom:1px solid var(--border-color); margin-bottom:1rem; overflow-x:auto; }
        .tab button { background:none; border:none; color:var(--text-color-secondary); padding:0.9rem 0.6rem; margin:0 0.6rem; cursor:pointer; font-family:'Google Sans',sans-serif; font-size:15px; border-bottom:3px solid transparent; }
        .tab button:hover { color:var(--text-color-primary); }
        .tab button.active { color:var(--link-color); border-bottom-color:var(--link-color); }

        .tabcontent { display:none; }
        .tabcontent:first-of-type { display:block; }

        .df { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1rem; flex-wrap:wrap; }
        .df h2 { font-family:'Google Sans',sans-serif; font-size:18px; font-weight:600; color:var(--text-color-primary); margin:0 }
        .df h3 { color:var(--text-color-secondary); margin:0; font-weight:600 }

        .action-bar { display:flex; gap:0.6rem; flex-wrap:wrap; margin-bottom:1rem }

        /* Buttons: keep classes but update hover to blue gradient */
        .btn { display:inline-flex; align-items:center; gap:0.5rem; padding:9px 12px; border-radius:10px; font-weight:600; cursor:pointer; font-family:'Google Sans',sans-serif; font-size:14px; border:1px solid var(--border-color); background:transparent; color:var(--text-color-primary); }
        .btn:hover { background: var(--btn-gradient); color: #fff; box-shadow: 0 12px 40px rgba(36,70,255,0.12); transform: translateY(-2px); }

        .btn-secondary {
            background-color: transparent; color: var(--link-color);
            border: 1px solid var(--border-color); padding: 9px 15px;
            border-radius: 10px; /* match primary button radius */
            transition: background 0.18s ease, box-shadow 0.18s ease, transform 0.18s ease;
        }
        /* Make secondary buttons use the site blue gradient on hover */
        .btn-secondary:hover {
            background: var(--btn-gradient);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 12px 40px rgba(36,70,255,0.12);
            transform: translateY(-2px);
            border-radius: 10px; 
        }
        .btn-danger { background: transparent; color: var(--danger-color); border: 1px solid var(--danger-color); }

        .filterInp { margin-bottom: 1rem; }
        .filterInp input { width:100%; max-width:360px; padding:10px 12px; border-radius:8px; border:1px solid var(--border-color); background:transparent; color:var(--text-color-primary); }
        .filterInp input:focus { outline:none; box-shadow: 0 8px 30px rgba(47,123,255,0.08); border-color: var(--accent-1); }

        .table-container { width:100%; overflow-x:auto; border-radius:8px; border:1px solid var(--border-color); background:var(--panel-bg); }
        table { width:100%; border-collapse:collapse; }
        thead { background: var(--surface); }
        th, td { padding:12px 14px; text-align:left; border-bottom:1px solid var(--border-color); color:var(--text-color-primary); }
        th { color:var(--text-color-secondary); font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:0.6px; }
        tbody tr:hover { background: var(--hover-bg-color); }
        td { white-space: nowrap; }

        .w3-button { background:none; border:none; color:inherit; padding:0; cursor:pointer; font-family:inherit; }

        /* Theme toggle */
        #theme-toggle { width:40px; height:40px; border-radius:50%; display:grid; place-items:center; border:1px solid var(--border-color); background:var(--panel-bg); cursor:pointer; }
        #theme-toggle .icon { width:20px; height:20px; fill:var(--text-color-secondary); }
        #theme-toggle:focus { outline:none; box-shadow: 0 0 0 3px rgba(47,123,255,0.12); }

        .icon-sun{display:none}.icon-moon{display:block}body.light-mode .icon-sun{display:block}body.light-mode .icon-moon{display:none}

        @media (max-width: 820px) {
            .card { max-width: 100%; border-radius: 0; }
            .dashboard-container { padding: 18px; }
            .headings { gap:0.6rem; }
            .tab { overflow-x:auto; }
            .filterInp input { max-width:100%; }
        }

        @media (max-width: 480px) {
            .logo { width:36px; height:36px }
            th, td { padding:10px }
        }

        mark { background:#ffdd00; color:#000; padding:2px 3px; border-radius:3px }

        /* Temporary: force light theme and hide the theme toggle (will be re-enabled later) */
        #theme-toggle { display: none !important; visibility: hidden !important; }
    </style>
</head>
<body class="light-mode">
    <div class="dashboard-container">
        <div class="headings">
            <div class="logo-title">
                <img src="logo.png" alt="{{productname}} Logo" class="logo">
                <div class="title-group">
                    <h1>{{productname}}</h1>
                    <h2>Admin Dashboard</h2>
                </div>
            </div>
            <div class="header-actions">
                <div class="counts">
                    <h3 id="logcount">0 Logs</h3>
                    <h3 id="usercount">0 Users</h3>
                </div>
                <button id="theme-toggle" title="Toggle light/dark theme">
                    <svg class="icon icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zM18.36 5.64l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0zM6.7 17.3c-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06c-.39-.39-1.02-.39-1.41 0z"/></svg>
                    <svg class="icon icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>
                </button>
                <a href="/dashboardlogout" class="btn btn-danger">Logout</a>
            </div>
        </div>
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'userstab');">Users</button>
            <button class="tablinks" onclick="openTab(event, 'logstab');">Logs</button>
            <button class="tablinks" onclick="fintechCode();">Get Fintech Auth Code</button>
        </div>

        <div id="logstab" class="tabcontent">
            <div class="df">
                <h2>Authentication Logs</h2>
                <h3 id="filtercount">0 Results</h3>
            </div>
            <div class="action-bar">
                <button onclick="populateTable();" class="btn">Refresh</button>
                <button onclick="window.open('/analyticsdashboard');" class="btn-secondary">Advanced Analytics</button>
                <button onclick="validatesig();" class="btn-secondary">Validate Document Signature</button>
            </div>
            <div class="filterInp">
                <input type="text" id="myinput" placeholder="Search logs..." title="Type in something" />
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><span id="name" class="w3-button table-column">Name <i class="caret"></i></span></th>
                            <th><span id="email" class="w3-button table-column">Email <i class="caret"></i></span></th>
                            <th><span id="requester" class="w3-button table-column">Requester <i class="caret"></i></span></th>
                            <th><span id="timestamp" class="w3-button table-column">Date and Time <i class="caret"></i></span></th>
                            <th><span id="ip" class="w3-button table-column">Client IP <i class="caret"></i></span></th>
                        </tr>
                    </thead>
                    <tbody id="mytable"></tbody>
                </table>
            </div>
        </div>

        <div id="userstab" class="tabcontent">
            <div class="df">
                <h2>User Management</h2>
                <h3 id="userfiltercount">0 Results</h3>
            </div>
            <div class="action-bar">
                <button onclick="populateUserTable();" class="btn">Refresh</button>
                <a href="/register" class="btn">Register New User</a>
            </div>
            <div class="filterInp">
                <input type="text" id="myinput2" placeholder="Search users..." title="Type in something" />
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><span id="name" class="w3-button table-column2">Name <i class="caret"></i></span></th>
                            <th><span id="email" class="w3-button table-column2">Email <i class="caret"></i></span></th>
                            <th><span id="edit" class="w3-button table-column2">Modify</span></th>
                            <th><span id="makeadmin" class="w3-button table-column2">Make Admin</span></th>
                        </tr>
                    </thead>
                    <tbody id="mytable2"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function validatesig() {
            filehash = prompt("Enter file hash");
            signer = prompt("Enter signer email");
            window.open("/adminsignvalidate?hash=" + filehash + "&signer=" + signer, "popup");
        }

        var table = document.getElementById("mytable");
        var input = document.getElementById("myinput");
        var tableData = [];
        var tableData2 = [];
        var table2 = document.getElementById("mytable2");
        var input2 = document.getElementById("myinput2");
        var caretUpClassName = "fa fa-caret-up";
        var caretDownClassName = "fa fa-caret-down";
        
        const sort_by = (field, reverse, primer) => {
            const key = primer ? function (x) { return primer(x[field]); } : function (x) { return x[field]; };
            reverse = !reverse ? 1 : -1;
            return function (a, b) { return (a = key(a)), (b = key(b)), reverse * ((a > b) - (b > a)); };
        };

        function clearArrow() {
            let carets = document.getElementsByClassName("caret");
            for (let caret of carets) { caret.className = "caret"; }
        }

        function toggleArrow(event) {
            let element = event.target;
            let caret, field, reverse;
            if (element.tagName === "SPAN") {
                caret = element.getElementsByClassName("caret")[0];
                field = element.id;
            } else {
                caret = element;
                field = element.parentElement.id;
            }
            let iconClassName = caret.className;
            clearArrow();
            if (iconClassName.includes(caretUpClassName)) {
                caret.className = `caret ${caretDownClassName}`;
                reverse = false;
            } else {
                reverse = true;
                caret.className = `caret ${caretUpClassName}`;
            }
            tableData.sort(sort_by(field, reverse));
            populateTableNoFetch();
        }

        function toggleArrow2(event) {
            let element = event.target;
            let caret, field, reverse;
            if (element.tagName === "SPAN") {
                caret = element.getElementsByClassName("caret")[0];
                field = element.id;
            } else {
                caret = element;
                field = element.parentElement.id;
            }
            let iconClassName = caret.className;
            clearArrow();
            if (iconClassName.includes(caretUpClassName)) {
                caret.className = `caret ${caretDownClassName}`;
                reverse = false;
            } else {
                reverse = true;
                caret.className = `caret ${caretUpClassName}`;
            }
            tableData2.sort(sort_by(field, reverse));
            populateUserTableNoFetch();
        }

        async function fetchUsers() {
            const response = await fetch("/all_users");
            tableData2 = await response.json();
            return tableData2;
        }

        async function fetchLogs() {
            const response = await fetch("/all_logs");
            tableData = await response.json();
            return tableData;
        }

        function populateTable() {
            table.innerHTML = "";
            fetchLogs().then((data) => {
                tableData = data; // Update global data
                document.getElementById("logcount").innerHTML = tableData.length + " Logs";
                populateTableNoFetch(); // Use the common function to build rows
            });
        }
        
        function populateTableNoFetch() {
            table.innerHTML = "";
            for (let data of tableData) {
                let row = table.insertRow(-1);
                let name = row.insertCell(0); name.innerHTML = data.name; name.setAttribute('data-label', 'Name');
                let email = row.insertCell(1); email.innerHTML = data.email; email.setAttribute('data-label', 'Email');
                let requester = row.insertCell(2); requester.innerHTML = data.requester; requester.setAttribute('data-label', 'Requester');
                let timestamp = row.insertCell(3); timestamp.innerHTML = data.timestamp; timestamp.setAttribute('data-label', 'Date/Time');
                let ip = row.insertCell(4); ip.innerHTML = data.ip; ip.setAttribute('data-label', 'Client IP');
            }
            filterTable(); // Apply filter after populating
        }

        function populateUserTable() {
            table2.innerHTML = "";
            fetchUsers().then((data) => {
                tableData2 = data; // Update global data
                document.getElementById("usercount").innerHTML = tableData2.length + " Users";
                populateUserTableNoFetch(); // Use the common function to build rows
            });
        }
        
        function populateUserTableNoFetch() {
            table2.innerHTML = "";
            for (let data of tableData2) {
                let row = table2.insertRow(-1);
                let name = row.insertCell(0); name.innerHTML = data.name; name.setAttribute('data-label', 'Name');
                let email = row.insertCell(1); email.innerHTML = data.email; email.setAttribute('data-label', 'Email');
                let edit = row.insertCell(2); edit.innerHTML = `<button class="btn btn-secondary" onclick='editUser("${data.email}")'>Modify</button>`; edit.setAttribute('data-label', 'Modify');
                let makeadmin = row.insertCell(3); makeadmin.innerHTML = `<button class="btn btn-secondary" onclick='makeAdmin("${data.email}")'>Make Admin</button>`; makeadmin.setAttribute('data-label', 'Make Admin');
            }
            filterUserTable(); // Apply filter after populating
        }

        function editUser(email) {
            fetch("/modify", { body: "email=" + email, headers: { "Content-Type": "application/x-www-form-urlencoded" }, method: "post" })
                .then((response) => response.text())
                .then((text) => { alert(text); });
        
        }

        function makeAdmin(email) {
            fetch("/promoteadmin", { body: "email=" + email, headers: { "Content-Type": "application/x-www-form-urlencoded" }, method: "post" })
                .then((response) => response.text())
                .then((text) => { alert(text); });
        }

        function filterTable() {
            let filter = input.value;
            let rows = table.getElementsByTagName("TR");
            let cntelem = 0;

            for (let row of rows) {
                let rowVisible = false;
                for (let cell of row.cells) {
                    const originalText = cell.textContent;
                    cell.innerHTML = originalText; 

                    if (filter && originalText.toUpperCase().includes(filter.toUpperCase())) {
                        rowVisible = true;
                        const regex = new RegExp(filter, 'gi');
                        cell.innerHTML = originalText.replace(regex, (match) => `<mark>${match}</mark>`);
                    }
                }

                if (!filter || rowVisible) {
                    row.style.display = "";
                    cntelem++;
                } else {
                    row.style.display = "none";
                }
            }
            document.getElementById("filtercount").innerHTML = cntelem + " Results";
        }

        function filterUserTable() {
            let filter = input2.value;
            let rows = table2.getElementsByTagName("TR");
            let cntelem = 0;

            for (let row of rows) {
                let rowVisible = false;
                for (let cell of row.cells) {
                    // Skip action cells for highlighting
                    if (cell.getAttribute('data-label') === 'Modify' || cell.getAttribute('data-label') === 'Make Admin') {
                        if(cell.textContent.toUpperCase().includes(filter.toUpperCase())){
                            rowVisible = true;
                        }
                        continue;
                    }
                    const originalText = cell.textContent;
                    cell.innerHTML = originalText; 

                    if (filter && originalText.toUpperCase().includes(filter.toUpperCase())) {
                        rowVisible = true;
                        const regex = new RegExp(filter, 'gi');
                        cell.innerHTML = originalText.replace(regex, (match) => `<mark>${match}</mark>`);
                    }
                }

                if (!filter || rowVisible) {
                    row.style.display = "";
                    cntelem++;
                } else {
                    row.style.display = "none";
                }
            }
            document.getElementById("userfiltercount").innerHTML = cntelem + " Results";
        }
        
        input.addEventListener("keyup", filterTable);
        input2.addEventListener("keyup", filterUserTable);
        
        let tableColumns = document.getElementsByClassName("table-column");
        for (let column of tableColumns) { column.addEventListener("click", (event) => toggleArrow(event)); }
        let tableColumns2 = document.getElementsByClassName("table-column2");
        for (let column of tableColumns2) { column.addEventListener("click", (event) => toggleArrow2(event)); }
        
        function openTab(evt, tabName) {
            var tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
            var tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        function fintechCode() {
            fetch("/getfincode").then(res => res.text()).then(text => { prompt("This code will be shown only once. Copy it. " + text, text); });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.tablinks').click();
            populateTable();
            populateUserTable();
        });
        
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => { document.body.classList.toggle('light-mode'); });
    </script>
</body>
</html>
