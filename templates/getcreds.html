<!DOCTYPE html>
<html lang="en">
<head>
    <title>Set Up User Account - {{productname}}</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Align visuals with register/admin dashboard: dark aesthetic with light-mode override */
        :root {
            --bg-color: #0a0f1c;
            --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            --panel-bg: rgba(18,26,44,0.88);
            --border-color: rgba(255,255,255,0.06);
            --muted: rgba(230,237,243,0.65);
            --accent-1: #2f7bff;
            --accent-2: #57c2ff;
            --btn-gradient: linear-gradient(140deg, var(--accent-1), var(--accent-2));
            --text: #e6edf3;
            --shadow: 0 30px 80px rgba(2,6,16,0.6);
            --glow: rgba(90,140,255,0.12);
            --success-color: #81c995;
            --error-color: #f28b82;
        }

        body.light-mode {
            --bg-color: #ffffff;
            --card-bg: rgba(255,255,255,0.98);
            --panel-bg: #ffffff;
            --border-color: rgba(18,38,63,0.08);
            --muted: rgba(11,18,32,0.65);
            --accent-1: #2f7bff;
            --accent-2: #57c2ff;
            --btn-gradient: linear-gradient(140deg, var(--accent-1), var(--accent-2));
            --text: #0b1220;
            --shadow: 0 20px 60px rgba(16,24,40,0.06);
            --glow: rgba(36,70,255,0.06);
            --success-color: #1e8e3e;
            --error-color: #d93025;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html, body { height: 100%; font-family: 'Manrope', sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

        body {
            background: var(--bg-color);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 1.25rem;
            transition: background 200ms, color 200ms;
        }

        /* Subtle page background accents matching other pages */
        body::before { content: ""; position: fixed; inset: -20%; background: linear-gradient(160deg,#070b16,#0a1226,#0c1733); z-index: -2; filter: blur(12px); }
        body::after { content: ""; position: fixed; inset: -10%; background: radial-gradient(700px 600px at 75% 70%, rgba(255,255,255,0.04), transparent 55%); z-index: -1; opacity: 0.6; pointer-events: none; }
        body.light-mode::before { background: linear-gradient(180deg,#ffffff,#f7fbff); filter:none; }

        /* Card */
        main {
            width: 100%;
            max-width: 760px; /* constrain card width */
            margin: 24px auto; /* center horizontally and provide vertical gap */
            border-radius: 18px;
            padding: 28px 34px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            /* Limit height to viewport and allow internal scrolling when needed */
            max-height: calc(100vh - 64px);
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .header { width: 100%; margin-bottom: 18px; }
        .header h1 { font-family: 'Space Grotesk', sans-serif; font-size: 20px; font-weight: 700; margin: 0; color: var(--text); }

        /* Camera Viewport: responsive and centered */
        .camera-viewport {
            width: 100%;
            max-width: 640px; /* limit viewport width */
            aspect-ratio: 4 / 3; /* Maintain aspect ratio */
            position: relative;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 auto 18px; /* center inside the card */
            border: 1px solid var(--border-color);
            /* Prevent the viewport from growing taller than the card; keep it responsive */
            max-height: min(60vh, 520px);
            height: auto;
        }
        
        .camera-viewport video, .camera-viewport canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Show video by default, hide the canvas until a photo is taken */
        .camera-viewport video { display: block; }
        .camera-viewport canvas { display: none; }

        /* Actions: center children so the Click Photo button doesn't stretch full width */
        .actions { width: 100%; display:flex; flex-direction:column; gap: 16px; align-items: center; }
        .button-group { display:flex; gap: 12px; flex-wrap:wrap; justify-content:center; }

        /* Buttons: keep consistent size/shape; allow grouping to control layout */
        .btn { padding: 10px 18px; min-width: 220px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; color: #fff; background: var(--btn-gradient); box-shadow: 0 12px 40px rgba(36,70,255,0.06); }
        .btn:hover { filter: brightness(.98); box-shadow: 0 16px 48px rgba(36,70,255,0.12); }

        .btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border-color); padding: 9px 14px; border-radius: 10px; font-weight: 600; }
        .btn-secondary:hover { background: rgba(255,255,255,0.02); border-color: var(--accent-1); color: var(--text); box-shadow: 0 8px 30px var(--glow); }

        .status-messages p { font-size: 14px; min-height: 20px; color: var(--muted); }
        #platform { color: var(--success-color); }
        #roaming { color: var(--success-color); }

        .hidden { display: none; }

        /* Theme toggle */
        #theme-toggle { position: fixed; top: 20px; right: 20px; width: 44px; height: 44px; border-radius: 50%; display: grid; place-items: center; border: 1px solid var(--border-color); background: var(--panel-bg); cursor: pointer; }
        #theme-toggle .icon { width: 20px; height: 20px; fill: var(--muted); }
        #theme-toggle:hover { background: var(--btn-gradient); box-shadow: 0 10px 22px rgba(36,70,255,0.18); }
        #theme-toggle:hover .icon { fill: #fff; }
        .icon-sun{display:none}.icon-moon{display:block}body.light-mode .icon-sun{display:block}body.light-mode .icon-moon{display:none}

        @media (max-width: 820px) { main { max-width: 100%; border-radius: 12px; padding: 20px; } }
        @media (max-width: 560px) { main { padding: 20px; } .header h1 { font-size: 18px; } }
    </style>
</head>
<body>
    <button id="theme-toggle" title="Toggle light/dark theme">
        <svg class="icon icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zM18.36 5.64l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0zM6.7 17.3c-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06c-.39-.39-1.02-.39-1.41 0z"/></svg>
        <svg class="icon icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>
    </button>
    
    <main>
        <div class="header">
            <h1>Set Up Your Account</h1>
        </div>

        <div class="camera-viewport">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <div class="actions">
            <button id="click-photo" class="btn">Click Photo</button>
            
            <div class="button-group">
                <form class="form" id="imgform">
                    <input type="text" name="img" id="img" value="" class="hidden" />
                    <button type="submit" class="btn-secondary">1. Register Image</button>
                </form>
                <button onClick="register_fido_platform();" class="btn-secondary">2. Register This Device</button>
                <button onClick="register_fido_roaming();" class="btn-secondary">3. Register Security Key</button>
            </div>
            
            <div class="status-messages">
                <p id="platform"></p>
                <p id="roaming"></p>
            </div>

            <div class="button-group">
                <form class="form" id="signinform">
                    <input type="text" name="token" id="token" value="{{token}}" class="hidden" />
                    <button type="submit" class="btn-secondary">Generate Token</button>
                </form>
                <form>
                    <button type="button" class="btn" onClick="window.location.href='/user_save?token={{token}}';">Save and Exit</button>
                </form>
            </div>
        </div>
        
        <button id="start-camera" class="hidden">Start Camera</button>
    </main>

    <script src="/cbor.js"></script>
    <script>
        let camera_button = document.querySelector("#start-camera");
        let video = document.querySelector("#video");
        let click_button = document.querySelector("#click-photo");
        let canvas = document.querySelector("#canvas");
        const ctx = canvas.getContext('2d');

        camera_button.addEventListener("click", async function () {
            try {
                let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera:", err);
                alert("Could not access the camera. Please ensure you have given permission.");
            }
        });

        click_button.addEventListener("click", function () {
            // Match canvas dimensions to the video element to avoid stretching
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            video.style.display = "none";
            canvas.style.display = "block";
            let image_data_url = canvas.toDataURL("image/png");
            document.getElementById("img").setAttribute("value", image_data_url.substring(22));
        });

        // Auto-start camera
        document.getElementById("start-camera").click();
    </script>
    <script>
        const imgform = document.getElementById("imgform");
        imgform.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch("/add_image?token={{token}}", {
                method: "post",
                body: formData,
            })
            .then(function (response) {
                return response.text();
            })
            .then(function (text) {
                console.log(text);
                alert('Image registration status: ' + text);
            })
            .catch(function (error) {
                console.log(error);
            });
        });
    </script>
    <script>
        const signinform = document.getElementById("signinform");
        signinform.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch("/sign_in_token", {
                method: "post",
                body: formData,
            })
            .then(function (response) {
                return response.text();
            })
            .then(function (text) {
                console.log(text);
                alert('Token generation status: ' + text);
            })
            .catch(function (error) {
                console.log(error);
            });
        });
    </script>
    <script>
        function register_fido_platform() {
            fetch("/api/register_platform/begin?token={{token}}", {
                method: "POST",
            })
            .then(function (response) {
                if (response.ok) return response.arrayBuffer();
                throw new Error("Error getting registration data!");
            })
            .then(CBOR.decode)
            .then(function (options) {
                return navigator.credentials.create(options);
            })
            .then(function (attestation) {
                return fetch("/api/register_platform/complete?token={{token}}", {
                    method: "POST",
                    headers: { "Content-Type": "application/cbor" },
                    body: CBOR.encode({
                        attestationObject: new Uint8Array(
                            attestation.response.attestationObject
                        ),
                        clientDataJSON: new Uint8Array(
                            attestation.response.clientDataJSON
                        ),
                    }),
                });
            })
            .then(
                function (response) {
                    if (response.ok) {
                        document.getElementById("platform").innerHTML = "✅ Device registration successful";
                    } else {
                        document.getElementById("platform").innerHTML = "❌ Device registration failed";
                    }
                },
                function (reason) {
                    console.log(reason);
                    document.getElementById("platform").innerHTML = "❌ Device registration failed";
                }
            );
        }

        function register_fido_roaming() {
            fetch("/api/register_roaming/begin?token={{token}}", {
                method: "POST",
            })
            .then(function (response) {
                if (response.ok) return response.arrayBuffer();
                throw new Error("Error getting registration data!");
            })
            .then(CBOR.decode)
            .then(function (options) {
                return navigator.credentials.create(options);
            })
            .then(function (attestation) {
                return fetch("/api/register_roaming/complete?token={{token}}", {
                    method: "POST",
                    headers: { "Content-Type": "application/cbor" },
                    body: CBOR.encode({
                        attestationObject: new Uint8Array(
                            attestation.response.attestationObject
                        ),
                        clientDataJSON: new Uint8Array(
                            attestation.response.clientDataJSON
                        ),
                    }),
                });
            })
            .then(
                function (response) {
                    if (response.ok) {
                        document.getElementById("roaming").innerHTML = "✅ Security key registration successful";
                    } else {
                        document.getElementById("roaming").innerHTML = "❌ Security key registration failed";
                    }
                },
                function (reason) {
                    console.log(reason);
                    document.getElementById("roaming").innerHTML = "❌ Security key registration failed";
                }
            );
        }
    </script>
    <script>
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
        });
    </script>
</body>
</html>



