<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
       
        color: #e9e9e9;
      background: linear-gradient(-45deg, #0f092b, #411325, #112c36, #102c26);
	      background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }


@keyframes gradient {
	0% {
		background-position: 0% 50%;
	}
	50% {
		background-position: 100% 50%;
	}
	100% {
		background-position: 0% 50%;
	}
}


      .box {
        height: 640px;
        width: 480px;
        border-radius: 20px;
        box-shadow: rgba(0, 0, 0, 0.16) 0px 10px 36px 0px,
          rgba(0, 0, 0, 0.06) 0px 0px 0px 1px;
      }
      .stack {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 20px;
      }
      .stack video {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
        aspect-ratio: 4/3;
        border-radius: 20px;
      }
      .stack video{
        object-fit: contain;
      }
      .stack canvas {
        position: absolute;
        top: 0;
        left: 0;
        aspect-ratio: 4/3;
        border-radius: 20px;
        object-fit: cover;
      }
      .buttons {
        display: flex;
        flex-direction: row;
        justify-content: space-evenly;
        align-items: center;
        border-radius: 20px;
        margin-top: 30px;
        
      }
      .buttons form{
        margin: 0;
      }
      #click-photo{
        margin-top: 30px;
        background-color: #2f3192;
        color: #fff;
      }
      #click-photo:hover{
        background-color: #fff;
        color: #000000;
      }
      /* style for button and input field button */
      button, input[type="submit"]{
        background-color: #f5f5f5;
        border: 1px solid black;
        border-radius: 10px;
        padding: 10px 20px;
        font-size: 16px;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #000;
        margin: 0 20px;
        transition: all 0.2s ease-in-out;
      }

      /* style for button and input field button */
      button:hover, input[type="submit"]:hover{
        background-color: #2f3192;
        color: #fff;
        cursor: pointer;
      }

      /* media quiry at 630px  */
      @media screen and (max-width: 480px) {
        .box {
          height: 640px;
          width: 480px;
        }
        .stack {
          height: 640px;
          width: 480px;
        }
        .buttons {
          /* flex-direction: column; */
          flex-wrap: wrap;
        }
        button, input[type="submit"]{
          margin: 10px;
        }
        .stack canvas {
        height: 640px;
          width: 480px;
      }
      .stack video {
        height: 640px;
          width: 480px;
      }
      }

    </style>
  </head>
  <body>
    <script src="/cbor.js"></script>
    <h1>Set up user account</h1>
    <button id="start-camera" hidden>Start Camera</button>
    <div class="box">
      <div class="stack">
        <video id="video" width="480" height="640" autoplay></video>
        <canvas id="canvas" width="480" height="640"></canvas>
      </div>
    </div>
    <button id="click-photo">Click Photo</button>
    <div class="buttom">

      <div class="buttons">
        
        <form class="form" id="imgform">
          <input type="text" name="img" id="img" value="" hidden />
          <button type="submit">Register image</button>
        </form>
        <button onClick="register_fido_platform();">Register this device</button>
        <button onClick="register_fido_roaming();">Register security key</button>
      </div>
      <p id="platform"></p>
      <p id="roaming"></p>
      <div class="buttons">
        
        <form class="form" id="signinform">
          <input type="text" name="token" id="token" value="{{token}}" hidden />
          <button type="submit">Generate token</button>
        </form>
        
        <form action="/user_save?token={{token}}">
          <input type="submit" value="Save and exit" />
        </form>
      </div>
    </div>
    <script>
      let camera_button = document.querySelector("#start-camera");
      let video = document.querySelector("#video");
      let click_button = document.querySelector("#click-photo");
      let canvas = document.querySelector("#canvas");

      camera_button.addEventListener("click", async function () {
        let stream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: false,
        });
        video.srcObject = stream;
      });

      click_button.addEventListener("click", function () {
        canvas
          .getContext("2d")
          .drawImage(video, 0, 0, canvas.width, canvas.height);
        document.getElementById("video").style.display = "none";
        let image_data_url = canvas.toDataURL("image/png");
        // data url of the image
        document
          .getElementById("img")
          .setAttribute("value", image_data_url.substring(22));
      });
      document.getElementById("start-camera").click();
    </script>
    <script>
      const imgform = document.getElementById("imgform");
      imgform.addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("/add_image?token={{token}}", {
          method: "post",
          body: formData,
        })
          .then(function (response) {
            return response.text();
          })
          .then(function (text) {
            console.log(text);
          })
          .catch(function (error) {
            console.log(error);
          });
      });
    </script>
    <script>
      const signinform = document.getElementById("signinform");
      signinform.addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("/sign_in_token", {
          method: "post",
          body: formData,
        })
          .then(function (response) {
            return response.text();
          })
          .then(function (text) {
            console.log(text);
          })
          .catch(function (error) {
            console.log(error);
          });
      });
    </script>
    <script>
      function register_fido_platform() {
        fetch("/api/register_platform/begin?token={{token}}", {
          method: "POST",
        })
          .then(function (response) {
            if (response.ok) return response.arrayBuffer();
            throw new Error("Error getting registration data!");
          })
          .then(CBOR.decode)
          .then(function (options) {
            return navigator.credentials.create(options);
          })
          .then(function (attestation) {
            return fetch("/api/register_platform/complete?token={{token}}", {
              method: "POST",
              headers: { "Content-Type": "application/cbor" },
              body: CBOR.encode({
                attestationObject: new Uint8Array(
                  attestation.response.attestationObject
                ),
                clientDataJSON: new Uint8Array(
                  attestation.response.clientDataJSON
                ),
              }),
            });
          })
          .then(
            function (response) {
              var stat = response.ok ? "successful" : "unsuccessful";
              //alert('Registration ' + stat + ' More details in server log...');
              if (response.ok) {
                document.getElementById("platform").innerHTML =
                  "Device registration successful";
              } else {
                document.getElementById("platform").innerHTML =
                  "Device registration failed";
              }
            },
            function (reason) {
              //alert(reason);
            }
          )
          .then(function () {
            //window.location = '/';
          });
      }

      function register_fido_roaming() {
        fetch("/api/register_roaming/begin?token={{token}}", {
          method: "POST",
        })
          .then(function (response) {
            if (response.ok) return response.arrayBuffer();
            throw new Error("Error getting registration data!");
          })
          .then(CBOR.decode)
          .then(function (options) {
            return navigator.credentials.create(options);
          })
          .then(function (attestation) {
            return fetch("/api/register_roaming/complete?token={{token}}", {
              method: "POST",
              headers: { "Content-Type": "application/cbor" },
              body: CBOR.encode({
                attestationObject: new Uint8Array(
                  attestation.response.attestationObject
                ),
                clientDataJSON: new Uint8Array(
                  attestation.response.clientDataJSON
                ),
              }),
            });
          })
          .then(
            function (response) {
              var stat = response.ok ? "successful" : "unsuccessful";
              //alert('Registration ' + stat + ' More details in server log...');
              if (response.ok) {
                document.getElementById("roaming").innerHTML =
                  "Security key registration successful";
              } else {
                document.getElementById("roaming").innerHTML =
                  "Security key registration failed";
              }
            },
            function (reason) {
              //alert(reason);
            }
          )
          .then(function () {
            //window.location = '/';
          });
      }
    </script>
  </body>
</html>
